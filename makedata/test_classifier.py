#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
ë§›ì§‘ ë¦¬ë·° ë¶„ë¥˜ê¸° í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸

ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ëª‡ ê°œì˜ ìƒ˜í”Œ ë¦¬ë·°ë¡œ ë¶„ë¥˜ê¸°ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
"""

import pandas as pd
from restaurant_classifier import RestaurantReviewClassifier
import json

def test_single_reviews():
    """ê°œë³„ ë¦¬ë·° í…ŒìŠ¤íŠ¸"""
    print("=== ê°œë³„ ë¦¬ë·° ë¶„ë¥˜ í…ŒìŠ¤íŠ¸ ===\n")
    
    # ë¶„ë¥˜ê¸° ì´ˆê¸°í™”
    classifier = RestaurantReviewClassifier(model_name="gemma:2b")
    
    # ëª¨ë¸ í™•ì¸
    if not classifier.pull_model_if_needed():
        print("âŒ Gemma ëª¨ë¸ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        print("Ollamaê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
        return False
    
    # í…ŒìŠ¤íŠ¸ ë¦¬ë·°ë“¤
    test_reviews = [
        "ë‹­ê°ˆë¹„ê°€ ì •ë§ ë§›ìˆì—ˆì–´ìš”! ê°€ê²©ë„ ì €ë ´í•˜ê³  ì „ì²´ì ìœ¼ë¡œ ë§Œì¡±ìŠ¤ëŸ¬ì› ìŠµë‹ˆë‹¤.",
        "íŒŒìŠ¤íƒ€ê°€ ë„ˆë¬´ ì§œì„œ ë³„ë¡œì˜€ì–´ìš”. ê°€ê²©ëŒ€ë¹„ í’ˆì§ˆì´ ì•„ì‰½ìŠµë‹ˆë‹¤.",
        "ì‚¼ê²¹ì‚´ì´ ë¶€ë“œëŸ½ê³  ë§›ìˆë„¤ìš”. ê°€ì„±ë¹„ ìµœê³ ì—ìš”! ì™„ì „ ì¶”ì²œí•©ë‹ˆë‹¤.",
        "í”¼ìê°€ ë‹¬ì½¤í•˜ê³  ë§›ìˆì–´ìš”. í•˜ì§€ë§Œ ì¢€ ë¹„ì‹¼ í¸ì´ì—ìš”.",
        "í•´ì‚°ë¬¼ ìš”ë¦¬ê°€ ì‹ ì„ í•˜ê³  ì¢‹ì•˜ìŠµë‹ˆë‹¤. ë¶„ìœ„ê¸°ë„ ì¢‹ê³  ì¬ë°©ë¬¸ ì˜ì‚¬ ìˆì–´ìš”."
    ]
    
    # ê° ë¦¬ë·° ë¶„ë¥˜
    for i, review in enumerate(test_reviews, 1):
        print(f"ğŸ“ í…ŒìŠ¤íŠ¸ {i}:")
        print(f"ë¦¬ë·°: {review}")
        
        try:
            result = classifier.classify_single_review(review)
            
            print("ë¶„ë¥˜ ê²°ê³¼:")
            print(f"  ë§›: {result.get('ë§›', 'ì •ë³´ì—†ìŒ')}")
            print(f"  ìŒì‹ì¢…ë¥˜: {result.get('ìŒì‹ì¢…ë¥˜', 'ì •ë³´ì—†ìŒ')}")
            print(f"  í‰ê°€: {result.get('í‰ê°€', 'ì •ë³´ì—†ìŒ')}")
            print(f"  ê°€ê²©: {result.get('ê°€ê²©', 'ì •ë³´ì—†ìŒ')}")
            print("-" * 60)
            
        except Exception as e:
            print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
            print("-" * 60)
    
    return True

def create_sample_csv():
    """í…ŒìŠ¤íŠ¸ìš© ìƒ˜í”Œ CSV íŒŒì¼ ìƒì„±"""
    print("\n=== ìƒ˜í”Œ CSV íŒŒì¼ ìƒì„± ===")
    
    sample_data = {
        'ê²€ìƒ‰ì–´': ['ë§›ì§‘'] * 5,
        'ë³¸ë¬¸ë‚´ìš©': [
            "ë‹­ê°ˆë¹„ê°€ ì •ë§ ë§›ìˆì—ˆì–´ìš”! ê°€ê²©ë„ ì €ë ´í•˜ê³  ì „ì²´ì ìœ¼ë¡œ ë§Œì¡±ìŠ¤ëŸ¬ì› ìŠµë‹ˆë‹¤. ì–‘ë„ ì¶©ë¶„í•˜ê³  ì§ì›ë¶„ë“¤ë„ ì¹œì ˆí•´ìš”.",
            "íŒŒìŠ¤íƒ€ê°€ ë„ˆë¬´ ì§œì„œ ë³„ë¡œì˜€ì–´ìš”. ê°€ê²©ëŒ€ë¹„ í’ˆì§ˆì´ ì•„ì‰½ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ê°€ê³  ì‹¶ì§€ ì•Šë„¤ìš”.",
            "ì‚¼ê²¹ì‚´ì´ ë¶€ë“œëŸ½ê³  ë§›ìˆë„¤ìš”. ê°€ì„±ë¹„ ìµœê³ ì—ìš”! ì™„ì „ ì¶”ì²œí•©ë‹ˆë‹¤. ì‚¬ì¥ë‹˜ë„ ì •ë§ ì¹œì ˆí•˜ì„¸ìš”.",
            "í”¼ìê°€ ë‹¬ì½¤í•˜ê³  ë§›ìˆì–´ìš”. ì¹˜ì¦ˆë„ ì«„ê¹ƒí•˜ê³  ë„ìš°ë„ ë°”ì‚­í•´ìš”. í•˜ì§€ë§Œ ì¢€ ë¹„ì‹¼ í¸ì´ì—ìš”.",
            "í•´ì‚°ë¬¼ ìš”ë¦¬ê°€ ì‹ ì„ í•˜ê³  ì¢‹ì•˜ìŠµë‹ˆë‹¤. íšŒê°€ ì •ë§ ë‹¬ì½¤í•˜ê³  ë§›ìˆì–´ìš”. ë¶„ìœ„ê¸°ë„ ì¢‹ê³  ì¬ë°©ë¬¸ ì˜ì‚¬ ìˆì–´ìš”."
        ],
        'ì œëª©': [
            "ë§›ìˆëŠ” ë‹­ê°ˆë¹„ ë§›ì§‘ í›„ê¸°",
            "íŒŒìŠ¤íƒ€ ë§›ì§‘ì´ë¼ê³  í•´ì„œ ê°”ëŠ”ë°...",
            "ì‚¼ê²¹ì‚´ ì§„ì§œ ë§›ì§‘ ë°œê²¬!",
            "í”¼ì ë§›ì§‘ ì¶”ì²œ",
            "í•´ì‚°ë¬¼ ìš”ë¦¬ ì „ë¬¸ì  í›„ê¸°"
        ],
        'ë¸”ë¡œê±°': ['í…ŒìŠ¤íŠ¸ë¸”ë¡œê±°'] * 5,
        'ì‘ì„±ì¼': ['2024-01-01'] * 5,
        'ë§í¬': ['http://test.com'] * 5
    }
    
    df = pd.DataFrame(sample_data)
    df.to_csv('sample_reviews.csv', index=False, encoding='utf-8-sig')
    print("âœ… 'sample_reviews.csv' íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
    
    return 'sample_reviews.csv'

def test_csv_classification():
    """CSV íŒŒì¼ ë¶„ë¥˜ í…ŒìŠ¤íŠ¸"""
    print("\n=== CSV íŒŒì¼ ë¶„ë¥˜ í…ŒìŠ¤íŠ¸ ===")
    
    # ìƒ˜í”Œ CSV ìƒì„±
    sample_file = create_sample_csv()
    
    # ë¶„ë¥˜ê¸° ì´ˆê¸°í™”
    classifier = RestaurantReviewClassifier(model_name="gemma:2b")
    
    try:
        # CSV íŒŒì¼ ë¶„ë¥˜
        output_file = 'test_classified_reviews.csv'
        classifier.classify_csv_file(
            input_file=sample_file,
            output_file=output_file,
            sample_size=None  # ì „ì²´ ì²˜ë¦¬ (ìƒ˜í”Œì´ ì ìœ¼ë¯€ë¡œ)
        )
        
        # ê²°ê³¼ ì¶œë ¥
        classifier.show_sample_results(output_file, num_samples=5)
        
        print(f"\nâœ… ë¶„ë¥˜ ê²°ê³¼ê°€ '{output_file}'ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
        
    except Exception as e:
        print(f"âŒ CSV ë¶„ë¥˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

def main():
    """ë©”ì¸ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜"""
    print("ğŸ§ª ë§›ì§‘ ë¦¬ë·° ë¶„ë¥˜ê¸° í…ŒìŠ¤íŠ¸ ì‹œì‘\n")
    
    # ê°œë³„ ë¦¬ë·° í…ŒìŠ¤íŠ¸
    if test_single_reviews():
        # CSV íŒŒì¼ í…ŒìŠ¤íŠ¸
        test_csv_classification()
    
    print("\nğŸ‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")
    print("\nğŸ’¡ íŒ:")
    print("- ì‹¤ì œ ë°ì´í„° ì²˜ë¦¬ëŠ” 'python restaurant_classifier.py' ì‹¤í–‰")
    print("- ëª¨ë¸ ë³€ê²½ì€ ìŠ¤í¬ë¦½íŠ¸ ë‚´ model_name íŒŒë¼ë¯¸í„° ìˆ˜ì •")
    print("- ì²˜ë¦¬ ì†ë„ê°€ ëŠë¦¬ë©´ gemma:2b ëª¨ë¸ ì‚¬ìš© ê¶Œì¥")

if __name__ == "__main__":
    main() 